<!DOCTYPE html>
<html>
<head>
    <title>Test Ark Address</title>
    <script src="src/js/bitcoinjs-3.3.2.min.js"></script>
    <script>
        // Bech32m decoder for verification
        var bech32m = {
            CHARSET: 'qpzry9x8gf2tvdw0s3jn54khce6mua7l',
            
            decode: function(str) {
                var lower = str.toLowerCase();
                var upper = str.toUpperCase();
                if (str !== lower && str !== upper) return null;
                str = lower;
                
                var split = str.lastIndexOf('1');
                if (split === -1) return null;
                if (split === 0) return null;
                
                var hrp = str.substring(0, split);
                var data = str.substring(split + 1);
                if (data.length < 6) return null;
                
                var values = [];
                for (var i = 0; i < data.length; i++) {
                    var idx = this.CHARSET.indexOf(data[i]);
                    if (idx === -1) return null;
                    values.push(idx);
                }
                
                if (!this.verifyChecksum(hrp, values)) return null;
                
                return {
                    hrp: hrp,
                    data: values.slice(0, values.length - 6)
                };
            },
            
            fromWords: function(words) {
                var res = [];
                var acc = 0;
                var bits = 0;
                for (var i = 0; i < words.length; i++) {
                    acc = (acc << 5) | words[i];
                    bits += 5;
                    while (bits >= 8) {
                        bits -= 8;
                        res.push((acc >> bits) & 0xff);
                    }
                }
                return res;
            },
            
            polymod: function(values) {
                var gen = [0x3b6a57b2, 0x26508e6d, 0x1ea119fa, 0x3d4233dd, 0x2a1462b3];
                var chk = 1;
                for (var i = 0; i < values.length; i++) {
                    var top = chk >> 25;
                    chk = (chk & 0x1ffffff) << 5 ^ values[i];
                    for (var j = 0; j < 5; j++) {
                        if ((top >> j) & 1) {
                            chk ^= gen[j];
                        }
                    }
                }
                return chk;
            },
            
            verifyChecksum: function(hrp, data) {
                var values = [];
                for (var i = 0; i < hrp.length; i++) {
                    values.push(hrp.charCodeAt(i) >> 5);
                }
                values.push(0);
                for (var i = 0; i < hrp.length; i++) {
                    values.push(hrp.charCodeAt(i) & 31);
                }
                values = values.concat(data);
                return this.polymod(values) === 0x2bc830a3; // Bech32m constant
            }
        };
        
        function testAddress() {
            var address = document.getElementById('address').value;
            var output = document.getElementById('output');
            
            try {
                // Decode the address
                var decoded = bech32m.decode(address);
                if (!decoded) {
                    output.innerHTML = '<span style="color:red">Invalid bech32m address</span>';
                    return;
                }
                
                // Convert from 5-bit words to bytes
                var bytes = bech32m.fromWords(decoded.data);
                
                var html = '<h3>Decoded Ark Address:</h3>';
                html += '<p><strong>HRP:</strong> ' + decoded.hrp + '</p>';
                html += '<p><strong>Total bytes:</strong> ' + bytes.length + '</p>';
                
                if (bytes.length === 65) {
                    // Extract components
                    var version = bytes[0];
                    var serverPubkey = bytes.slice(1, 33);
                    var vtxoTaprootKey = bytes.slice(33, 65);
                    
                    html += '<p><strong>Version:</strong> ' + version + '</p>';
                    html += '<p><strong>Server Pubkey (hex):</strong> ' + toHex(serverPubkey) + '</p>';
                    html += '<p><strong>VTXO Taproot Key (hex):</strong> ' + toHex(vtxoTaprootKey) + '</p>';
                    html += '<p style="color:green"><strong>âœ“ Valid Ark address format!</strong></p>';
                } else {
                    html += '<p style="color:red">Invalid data length. Expected 65 bytes, got ' + bytes.length + '</p>';
                }
                
                output.innerHTML = html;
                
            } catch (e) {
                output.innerHTML = '<span style="color:red">Error: ' + e.message + '</span>';
            }
        }
        
        function toHex(bytes) {
            var hex = '';
            for (var i = 0; i < bytes.length; i++) {
                var h = bytes[i].toString(16);
                if (h.length === 1) h = '0' + h;
                hex += h;
            }
            return hex;
        }
    </script>
</head>
<body>
    <h1>Test Ark Address Decoder</h1>
    <p>Paste an Ark address to verify its format:</p>
    <input type="text" id="address" value="tark1qra883hysahlkt0ujcwhv0x2n278849c3m7t3a08l7fdc40f4f2nmmrf2eau3k5f4cy7nrp7xlltww7cw0wjf4ey8c5dcqmgaeqpk3cxqujkmd" style="width: 100%; padding: 10px;">
    <br><br>
    <button onclick="testAddress()">Decode Address</button>
    <br><br>
    <div id="output"></div>
</body>
</html>